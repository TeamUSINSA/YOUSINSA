<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.order.cancelreturn">

  <select id="selectCancelReturnList"
          parameterType="map"
          resultType="dto.user.CancelReturn">
    <!-- 1) 취소 내역 (delivery_status 반드시 'CANCELLED') -->
    SELECT
      c.cancel_date      AS actionDate,
      o.order_id         AS orderId,
      o.order_date       AS orderDate,
      NULL               AS orderItemId,
      NULL               AS productId,
      NULL               AS name,
      NULL               AS mainImage1,
      NULL               AS color,
      NULL               AS size,
      NULL               AS quantity,
      o.total_price      AS price,
      c.reason           AS reason,
      o.delivery_status  AS status
    FROM cancel c
    JOIN orderlist o ON c.order_id = o.order_id
    WHERE c.user_id = #{userId}
      AND o.delivery_status = 'CANCELLED'
      <if test="startDate != null and startDate != ''">
        AND c.cancel_date BETWEEN #{startDate} AND #{endDate}
      </if>

    UNION ALL

    <!-- 2) 반품 내역 (delivery_status 반드시 'RETURNED') -->
    SELECT
      r.return_date      AS actionDate,
      o.order_id         AS orderId,
      o.order_date       AS orderDate,
      r.order_item_id    AS orderItemId,
      i.product_id       AS productId,
      p.name             AS name,
      p.main_image1      AS mainImage1,
      i.color            AS color,
      i.size             AS size,
      i.quantity         AS quantity,
      (p.cost * i.quantity) AS price,
      r.reason           AS reason,
      o.delivery_status  AS status
    FROM `return` r
    JOIN orderitem   i ON r.order_item_id = i.order_item_id
    JOIN orderlist   o ON i.order_id       = o.order_id
    JOIN product     p ON i.product_id     = p.product_id
    WHERE r.user_id = #{userId}
      AND o.delivery_status = 'RETURNED'
      <if test="startDate != null and startDate != ''">
        AND r.return_date BETWEEN #{startDate} AND #{endDate}
      </if>

    ORDER BY actionDate DESC
  </select>

</mapper>
